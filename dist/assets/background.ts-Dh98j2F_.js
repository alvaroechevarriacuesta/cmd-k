const f=async(c,a)=>{const o=chrome.identity.getRedirectURL(),e=m(),r=await w(e),t=c.params.echoClientId,n=c.params.echoBaseUrl,h=`${n}/api/oauth/authorize?response_type=code&client_id=${t}&redirect_uri=${encodeURIComponent(o+"echo/callback")}&code_challenge=${r}&code_challenge_method=S256&state=${crypto.randomUUID()}`;console.log("redirectUrl:",o),console.log("authUrl:",h),chrome.identity.launchWebAuthFlow({url:h,interactive:!0},async s=>{if(chrome.runtime.lastError){console.error("Error launching web auth flow:",chrome.runtime.lastError.message),a({success:!1,error:chrome.runtime.lastError.message});return}if(!s||s.includes("error")){console.log("Error in web auth flow:",s),a({success:!1,error:"Authentication failed"});return}const k=new URL(s),u=new URLSearchParams(k.search),i=u.get("code"),l=u.get("error");if(l){console.log("Error in web auth flow:",l),a({success:!1,error:l});return}if(i){const _=await g(i,e,n,t);a({success:!0,echoUser:_.tokenData.user,tokenData:_.tokenData})}else console.log("No authorization code found in redirect URL"),a({success:!1,error:"No authorization code found"})})},d=async(c,a,o,e)=>{try{const r=chrome.identity.getRedirectURL(),t=await fetch(`${a}/api/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",client_id:o,refresh_token:c,redirect_uri:r+"echo/callback"})});if(console.log("token exchange reponse status:",t.status),!t.ok){const s=await t.json();throw console.log("token exchange error:",s),new Error(s.error||"Token exchange failed")}const n=await t.json(),h={user:n.user,accessToken:n.access_token,accessTokenExpiresAt:Date.now()+n.expires_in*1e3,refreshToken:n.refresh_token,refreshTokenExpiresAt:Date.now()+n.refresh_token_expires_in*1e3};e({success:!0,tokenData:h})}catch(r){throw console.error("Error refreshing tokens:",r),r}},g=async(c,a,o,e)=>{try{const r=chrome.identity.getRedirectURL(),t=await fetch(`${o}/api/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",client_id:e,code_verifier:a,code:c,redirect_uri:r+"echo/callback"})});if(console.log("token exchange reponse status:",t.status),!t.ok){const s=await t.json();throw console.log("token exchange error:",s),new Error(s.error||"Token exchange failed")}const n=await t.json();return{success:!0,tokenData:{user:n.user,accessToken:n.access_token,accessTokenExpiresAt:Date.now()+n.expires_in*1e3,refreshToken:n.refresh_token,refreshTokenExpiresAt:Date.now()+n.refresh_token_expires_in*1e3}}}catch(r){throw console.error("Error exchanging code for token:",r),r}},m=()=>{const c=Math.floor(Math.random()*86)+43,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";let o="";const e=new Uint8Array(c);crypto.getRandomValues(e);for(let t=0;t<c;t++)o+=a[e[t]%a.length];if(o.length<43||o.length>128)throw new Error(`Generated code verifier length (${o.length}) is outside the required range (43-128)`);if(!/^[A-Za-z0-9\-._~]+$/.test(o))throw new Error("Generated code verifier contains invalid characters");return console.log(`Generated PKCE code verifier with length: ${o.length}`),o},w=async c=>x(await crypto.subtle.digest("SHA-256",new TextEncoder().encode(c))),x=c=>btoa(String.fromCharCode(...new Uint8Array(c))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"");chrome.runtime.onInstalled.addListener(async()=>{console.log("Web Cmd+K is installed");try{await chrome.sidePanel.setOptions({enabled:!0,path:"index.html"})}catch(c){console.error("Error setting side panel options:",c)}chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0})});chrome.commands.onCommand.addListener(c=>{c==="open-side-panel"&&chrome.tabs.query({active:!0,currentWindow:!0},a=>{const o=a[0]?.id;o?(console.log("Opening side panel on tab:",o),chrome.sidePanel.open({tabId:o})):console.warn("No active tab found")})});chrome.runtime.onMessage.addListener((c,a,o)=>{switch(c.action){case"AUTHENTICATE":console.log("Authentication request"),f(c,async e=>{e.success&&e.echoUser&&e.tokenData&&await chrome.storage.local.set({echo_user:e.echoUser,echo_access_token:e.tokenData.accessToken,echo_refresh_token:e.tokenData.refreshToken,echo_access_token_expires_at:e.tokenData.accessTokenExpiresAt,echo_refresh_token_expires_at:e.tokenData.refreshTokenExpiresAt}),console.log("Successfully authenticated"),o(e)});break;case"GET_USER":chrome.storage.local.get(["echo_user"],e=>{o({user:e.echo_user||null})});break;case"GET_TOKEN":console.log("Getting Echo token"),chrome.storage.local.get(["echo_access_token","echo_access_token_expires_at","echo_refresh_token","echo_refresh_token_expires_at"],e=>{const r=Date.now();e.echo_access_token&&e.echo_access_token_expires_at&&r<e.echo_access_token_expires_at?o({token:e.echo_access_token}):d(e.echo_refresh_token,c.params.echoBaseUrl,c.params.echoClientId,async t=>{t.success&&t.tokenData?(chrome.storage.local.set({echo_access_token:t.tokenData.accessToken,echo_access_token_expires_at:t.tokenData.accessTokenExpiresAt,echo_refresh_token:t.tokenData.refreshToken,echo_refresh_token_expires_at:t.tokenData.refreshTokenExpiresAt}),o({token:t.tokenData.accessToken})):(console.error("Error refreshing tokens:",t.error),o({token:null}))})});break;case"REFRESH_TOKEN":console.log("Getting Echo token"),chrome.storage.local.get(["echo_access_token","echo_access_token_expires_at","echo_refresh_token","echo_refresh_token_expires_at"],e=>{const r=Date.now();e.echo_access_token&&e.echo_access_token_expires_at&&r<e.echo_access_token_expires_at?o({token:e.echo_access_token}):d(e.echo_refresh_token,c.params.echoBaseUrl,c.params.echoClientId,async t=>{t.success&&t.tokenData?(chrome.storage.local.set({echo_access_token:t.tokenData.accessToken,echo_access_token_expires_at:t.tokenData.accessTokenExpiresAt,echo_refresh_token:t.tokenData.refreshToken,echo_refresh_token_expires_at:t.tokenData.refreshTokenExpiresAt}),o({token:t.tokenData.accessToken})):(console.error("Error refreshing tokens:",t.error),o({token:null}))})});break;case"CHECK_AUTH":chrome.storage.local.get(["echo_user","echo_access_token","echo_access_token_expires_at"],e=>{const r=Date.now(),t=e.echo_user&&e.echo_access_token&&e.echo_access_token_expires_at&&r<e.echo_access_token_expires_at;o({isAuthenticated:t,user:t?e.echo_user:null,token:t?e.echo_access_token:null})});break;case"SIGN_OUT":chrome.storage.local.remove(["echo_user","echo_access_token","echo_refresh_token","echo_access_token_expires_at","echo_refresh_token_expires_at"],()=>{o({success:!0})});break;case"GET_TAB_CONTENT":chrome.tabs.query({active:!0,currentWindow:!0},async e=>{const r=e[0];if(console.log("Fetching content from active tab:",r?.url,"Tab ID:",r?.id),!r||!r.id){o({content:null,url:null,title:null});return}try{const n=(await chrome.scripting.executeScript({target:{tabId:r.id},func:()=>{const h=["article","main",'[role="main"]',"body"];let s=document.body;for(const l of h){const _=document.querySelector(l);if(_&&_.textContent&&_.textContent.trim().length>100){s=_;break}}const k=s.cloneNode(!0);k.querySelectorAll("script, style, noscript, iframe, embed, object").forEach(l=>l.remove());let i=k.innerText||k.textContent||"";return i=i.replace(/\s+/g," ").replace(/\n\s*\n/g,`
`).trim(),i.length>8e3&&(i=i.substring(0,8e3)+"..."),{content:i,url:window.location.href,title:document.title}}}))[0]?.result;o({content:n?.content||null,url:n?.url||r.url,title:n?.title||r.title})}catch(t){console.error("Error getting tab content:",t),o({content:null,url:r.url,title:r.title})}});break}return!0});
